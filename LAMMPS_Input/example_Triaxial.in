units metal
dimension 3
boundary s s s
atom_style atomic

# Read in data files
read_data 
read_restart 

reset_timestep 0 time 0

pair_style 
pair_coeff * * 

change_box all boundary s s s

# Define simulation variables
variable step equal step
variable temp equal temp
variable pe equal pe
variable etotal equal etotal
variable enthalpy equal enthalpy
variable press equal press
variable vol equal vol
variable pxx equal "-pxx"
variable pyy equal "-pyy"
variable pzz equal "-pzz"
variable pxy equal "-pxy"
variable pxz equal "-pxz"
variable pyz equal "-pyz"
variable lx equal lx
variable ly equal ly
variable lz equal lz
variable Dt equal dt
variable time equal time

variable RunNVE equal 
variable RunIndent equal 

compute PE_Atom all pe/atom
compute PE_Atoms all reduce sum c_PE_Atom
compute Sigma all stress/atom NULL
compute Stress all reduce sum c_Sigma[3]

# Time step and thermo settings
timestep 0.001
thermo 1000
thermo_style custom step temp pe c_PE_Atoms etotal enthalpy press vol pxx pyy pzz pxy pxz pyz lx ly lz
thermo_modify flush yes

# Fixes and settings
fix Ave all ave/time 10 100 1000 v_temp v_pe v_etotal v_enthalpy v_press v_vol v_pxx v_pyy v_pzz v_pxy v_pxz v_pyz v_lx v_ly v_lz file thermo_averages_beforeindent.txt


dump 1 all custom 1000 before.indent.dump id type x y z c_PE_Atom fx fy fz

# Run for setup
run 0 post no
restart 1000 beforeindent.restart.A beforeindent.restart.B

fix 1 all nve
fix 2 all temp/csvr 300.0 300.0 $(100*dt) 54324

# Define indenter planes along all three directions
fix 3 all indent 1000.0 plane z $(zhi+0.01) hi
fix 4 all indent 1000.0 plane z $(zlo-0.01) lo
fix 7 all indent 1000.0 plane y $(yhi+0.01) hi
fix 8 all indent 1000.0 plane y $(ylo-0.01) lo
fix 9 all indent 1000.0 plane x $(xhi+0.01) hi
fix 10 all indent 1000.0 plane x $(xlo-0.01) lo

# Run initial equilibration
run ${RunNVE}

# Unfix unnecessary settings before main run
unfix 2
unfix 3
unfix 4
unfix 7
unfix 8
unfix 9
unfix 10
unfix Ave
unfix Dt
restart 0
undump 1

reset_timestep 0 time 0

timestep 0.001

# Stress tensor output for stress visualization
dump 1 all custom 1000 indent.dump id type x y z c_PE_Atom fx fy fz c_Sigma[1] c_Sigma[2] c_Sigma[3] c_Sigma[4] c_Sigma[5] c_Sigma[6]

restart 1000 indent.restart.A indent.restart.B

# Run with indenter planes and displacement controls
run 0 post no

variable x0 equal $(xhi)
variable y0 equal $(yhi)
variable z0 equal $(zhi)
variable xl equal $(xlo)
variable yl equal $(ylo)
variable zl equal $(zlo)

variable indenter_vel equal -0.05
variable indenter_velo equal 0.05

variable z equal "z0 + indenter_vel*elaplong*dt"
variable z equal vdisplace(${z0},${indenter_vel})

variable zw equal "zl - indenter_velo*elaplong*dt"
variable zw equal vdisplace(${zl},${indenter_velo})

variable y equal "y0 + indenter_vel*elaplong*dt"
variable y equal vdisplace(${y0},${indenter_vel})

variable yw equal "yl - indenter_velo*elaplong*dt"
variable yw equal vdisplace(${yl},${indenter_velo})

variable x equal "x0 + indenter_vel*elaplong*dt"
variable x equal vdisplace(${x0},${indenter_vel})

variable xw equal "xl - indenter_velo*elaplong*dt"
variable xw equal vdisplace(${xl},${indenter_velo})



# Define initial dimensions and normalized variables
variable Lx0 equal ${lx}
variable Ly0 equal ${ly}
variable Lz0 equal ${lz}

variable Lx_norm equal "lx/v_Lx0"
variable Ly_norm equal "ly/v_Ly0"
variable Lz_norm equal "lz/v_Lz0"

# Define true strain for all three directions
variable true_strain_x equal "abs(ln(v_Lx_norm))*100"
variable true_strain_y equal "abs(ln(v_Ly_norm))*100"
variable true_strain_z equal "abs(ln(v_Lz_norm))*100"

# Define true stress for all three directions
variable true_stress_x equal "abs(f_9[1])/ly/lz*160.21766208"  # x-direction stress
variable true_stress_y equal "abs(f_7[2])/lx/lz*160.21766208"  # y-direction stress
variable true_stress_z equal "abs(f_3[3])/lx/ly*160.21766208"  # z-direction stress

# Reapply temperature control and indenter planes
fix 2 all temp/csvr 300.0 300.0 $(100*dt) 54324
fix 3 all indent 1000.0 plane z v_z hi
fix 4 all indent 1000.0 plane z v_zw lo
fix 7 all indent 1000.0 plane y v_y hi
fix 8 all indent 1000.0 plane y v_yw lo
fix 9 all indent 1000.0 plane x v_x hi
fix 10 all indent 1000.0 plane x v_xw lo  

# Output stress and strain information for x, y, and z directions
fix 5 all print 100 "$(v_step:%20.16g) $(v_Dt:%20.16g) $(v_time:%20.16g) $(v_true_strain_x:%20.16g) $(v_true_stress_x:%20.16g) $(v_true_strain_y:%20.16g) $(v_true_stress_y:%20.16g) $(v_true_strain_z:%20.16g) $(v_true_stress_z:%20.16g) $(f_3[1]:%20.16g) $(f_3[2]:%20.16g) $(f_3[3]:%20.16g) $(f_7[2]:%20.16g) $(f_9[1]:%20.16g) $(v_pxx:%20.16g) $(v_pyy:%20.16g) $(v_pzz:%20.16g) $(v_pyz:%20.16g) $(v_pxz:%20.16g) $(v_pxy:%20.16g) $(v_lx:%20.16g) $(v_ly:%20.16g) $(v_lz:%20.16g) $(v_temp:%20.16g) $(v_pe:%20.16g) $(v_etotal:%20.16g) $(v_enthalpy:%20.16g)" file thermo_indent.txt screen no title "Step Timestep Time True_Strain_X True_Stress_X True_Strain_Y True_Stress_Y True_Strain_Z True_Stress_Z Fx_Indenter Fy_Indenter Fz_Indenter Fy_Indenter_H Fx_Indenter_H SigmaXX SigmaYY SigmaZZ SigmaYZ SigmaXZ SigmaXY LX LY LZ Temp PE Total Enthalpy"

fix 11 all print 100 "$(f_3[3]:%20.16g) $(f_4[3]:%20.16g) $(f_7[2]:%20.16g) $(f_8[2]:%20.16g) $(f_9[1]:%20.16g) $(f_10[1]:%20.16g)" file Force_indent.txt screen no title "Fz_Indenter_H Fz_Indenter_L Fy_Indenter_H Fy_Indenter_L Fx_Indenter_H Fx_Indenter_L"

fix 6 all halt 1 v_Lz_norm < 0.5 error continue message yes

# Run the indentation simulation
run ${RunIndent}

# Clean up and save final state
unfix Balance
unfix Momentum
unfix 1
unfix 2
unfix 3
unfix 4
unfix 5
unfix 6
unfix 7
unfix 8
unfix 9
unfix 10
unfix 11
restart 0
undump 1
